名前：Lightning Network の理論的な紹介
目標：技術的な観点から Lightning Network を理解する
目的：

- ネットワークのチャネルの動作を理解する。
- HTLC、LNURL、UTXO という用語に慣れる。
- LNN の流動性と手数料の管理を理解する。
- ライトニングネットワークをネットワークとして認識する。
- ライトニングネットワークの理論的な利用方法を理解する。

# ビットコインの第 2 層への旅

このトレーニングは、Lightning Network の技術的な動作に関する理論的なコースです。

Lightning Network の世界へようこそ。これはビットコインの第 2 層であり、洗練された技術的な進歩と可能性に満ちたものです。この技術の技術的な深層に没頭する準備をしましょう。具体的なチュートリアルや使用シナリオには焦点を当てません。このトレーニングを最大限に活用するためには、ビットコインのしっかりとした理解が必要です。真剣で集中したアプローチが必要な体験です。また、この探求により実践的な側面を提供する LN 202 コースを並行して受講することも検討してください。ビットコインエコシステムの認識を変えるかもしれない旅に備えてください。

楽しい発見を！

+++

# 基礎知識

## Lightning Network の理解

![Lightning Networkの理解](https://youtu.be/PszWk046x-I)

ライトニングネットワークは、ビットコインネットワーク上に構築された第 2 層の支払いインフラであり、高速かつ低コストのトランザクションを可能にします。ライトニングネットワークの動作を完全に理解するには、支払いチャネルとその動作原理を理解することが不可欠です。

ライトニング上の支払いチャネルは、高速で繰り返し可能なビットコイントランザクションを可能にする、二つのユーザー間の「プライベートな経路」のようなものです。チャネルが開かれると、ユーザーによって事前に定義された固定容量が割り当てられます。この容量は、チャネル内で一度に送信できるビットコインの最大量を表します。

支払いチャネルは双方向です。つまり、二つの「側面」を持っています。例えば、Alice と Bob が支払いチャネルを開いた場合、Alice は Bob にビットコインを送信することができ、Bob も Alice にビットコインを送信することができます。チャネル内のトランザクションは、チャネルの総容量を変更しませんが、Alice と Bob の間でこの容量の分配を変更します。

![説明](assets/chapitre1/0.JPG)

ライトニング支払いチャネルでトランザクションを行うためには、資金を送信するユーザーは、チャネルの自身の側に十分なビットコインを持っている必要があります。例えば、Alice が彼らのチャネルを介して Bob に 1 ビットコインを送信したい場合、彼女はチャネルの自身の側に少なくとも 1 ビットコインを持っている必要があります。

ライトニング上の支払いチャネルの制約と動作原理
ライトニングネットワークの支払いチャネルの容量は固定されていますが、これはトランザクションの総数やビットコインの総量の制限ではありません。例えば、アリスとボブが 1 ビットコインの容量を持つチャネルを持っている場合、彼らは 0.01 ビットコインの数百回のトランザクションや 0.001 ビットコインの数千回のトランザクションを行うことができます。ただし、チャネルの総容量を超えない限りです。

これらの制限にもかかわらず、ライトニングネットワークの支払いチャネルは、高速かつ低コストでビットコインのトランザクションを行う効果的な手段です。これにより、ユーザーは高額な手数料を支払ったり、ビットコインネットワークでの長時間の確認を待つ必要なく、ビットコインを送受信することができます。

要約すると、ライトニングネットワーク上の支払いチャネルは、高速かつ低コストのビットコインのトランザクションを行いたい人々にとって強力な解決策を提供します。ただし、その動作と制限を理解し、最大限に活用するためには、その仕組みを理解することが重要です。

例：

- アリスは 100,000 SAT を持っています。
- ボブは 30,000 SAT を持っています。

これが現在のチャネルの状態です。トランザクションの際、アリスはボブに 40,000 SAT を送ることを決定します。アリスは 100,000 SAT よりも 40,000 SAT が少ないため、送ることができます。

したがって、チャネルの新しい状態は次のようになります：

- アリス 60,000 SAT
- ボブ 70,000 SAT

```
チャネルの初期状態：
アリス（100,000 SAT）==============ボブ（30,000 SAT）

アリスからボブへの40,000 SATの転送後：
アリス（60,000 SAT）==============ボブ（70,000 SAT）

```

その後、ボブはアリスに 80,000 SAT を送りたいと思います。しかし、流動性がないため、送ることができません。チャネルの最大容量は 130,000 SAT であり、アリスは 60,000 SAT まで、ボブは 70,000 SAT までの支出が可能です。

ビットコイン、アドレス、UTXO、トランザクションについて

この第 2 章では、ビットコインのトランザクションの実際の動作を学び、ライトニングを理解するために役立ちます。また、次の章であるライトニングネットワーク上のチャネルの開設に関する重要な概念であるマルチシグネチャアドレスについても簡単に説明します。

- 秘密鍵>公開鍵>アドレス：トランザクションの際、アリスはボブにお金を送ります。ボブは公開鍵によって与えられたアドレスを提供します。アリスは自身の公開鍵を使用してアドレスにお金を受け取り、トランザクションに署名するために秘密鍵を使用します。これにより、アドレスのビットコインがアンロックされます。
- ビットコインの取引では、すべてのビットコインが移動する必要があります。UTXO（未使用のトランザクション出力）と呼ばれるビットコインの断片は、すべてのオーナーに戻るまで出発します。
  アリスは 0.002 BTC を持っており、ボブは 0 BTC です。アリスは 0.0015 BTC をボブに送ることを決めます。彼女は 0.002 BTC のトランザクションに署名し、0.0015 BTC がボブに行き、0.0005 BTC が彼女のウォレットに戻ります。

![説明](assets/chapitre2/0.JPG)

ここでは、UTXO（アリスはアドレスに 0.0002 BTC を持っています）から 2 つの UTXO（ボブは 0.0015 を持ち、アリスは 0.0005 BTC の新しい UTXO（前のものとは独立して）を取得しました）が作成されました。

```
アリス（0.002 BTC）
  |
  V
ビットコインのトランザクション（0.002 BTC）
  |
  |----> ボブ（0.0015 BTC）
  |
  V
アリス（新しいUTXO：0.0005 BTC）
```

ライトニングネットワークでは、マルチシグネチャが使用されます。したがって、資金を解除するには 2 つの署名が必要であり、お金（UTXO）を移動するために 2 つの秘密鍵が必要です。したがって、アリスとボブは一緒にお金（UTXO）を解除することに同意する必要があります。LN では、これらは 2/2 のトランザクションであり、完全な鍵の組み合わせが必要ですが、2/3 または 3/5 のマルチシグネチャでは、完全な鍵の組み合わせが必要ではありません。

![説明](assets/chapitre2/1.JPG)

# チャネルの開設とクローズ

## チャネルの開設

![チャネルを開く](https://youtu.be/B2caBC0Rxko)

今、私たちはチャネルの開設について詳しく見ていき、これがビットコインのトランザクションを介してどのように行われるかを説明します。

ライトニングネットワークにはさまざまな通信レベルがあります：

- P2P 通信（ライトニングネットワークプロトコル）
- ペイメントチャネル（ライトニングネットワークプロトコル）
- ビットコインのトランザクション（ビットコインプロトコル）

![説明](assets/chapitre3/0.JPG)

チャネルを開くために、2 つのペアはチャネルを介して通信します：

- アリス：「こんにちは、チャネルを開きたいです！」
- ボブ：「わかりました、ここに公開鍵があります。」

![説明](assets/chapitre3/1.JPG)

アリスは今や 2 つの公開鍵を持っており、2/2 のマルチシグアドレスを作成することができます。彼女は今、お金を送るためにビットコインのトランザクションを作成することができます。

アリスは 0.002 BTC の UTXO を持っており、ボブと 0.0013 BTC のチャネルを開きたいとします。したがって、彼女は 2 つの UTXO を出力するトランザクションを作成します：

- 0.0013 BTC の UTXO を 2/2 のマルチシグアドレスに送る
- 0.0007 BTC の UTXO を交換用のアドレスの 1 つに送る（UTXO の返却）
  このトランザクションはまだ公開されていません。なぜなら、この段階では Bob がマルチシグのお金を解除できることを信頼しているからです。
  では、どうすればいいのでしょうか？

Alice は、マルチシグへの入金を公開する前に、「引き出しトランザクション」と呼ばれる 2 番目のトランザクションを作成します。

![説明](assets/chapitre3/2.JPG)

引き出しトランザクションは、マルチシグのアドレスから彼女自身のアドレスに資金を支出します（すべてが公開される前に）。

2 つのトランザクションが作成されたら、彼女は Bob にそれを伝え、彼に彼の公開鍵で署名を求めます。これにより、何か問題が発生した場合に彼女が資金を回収できるようになります。Bob は不正ではないので、これを受け入れます。

したがって、Alice は Bob の署名を持っているため、彼女は単独で資金を回収することができます。したがって、彼女はトランザクションを公開します。したがって、Alice の側には現在 0.0013 BTC（130,000 SAT）があります。

![説明](assets/chapitre3/3.JPG)

## Lightning トランザクションとコミットメントトランザクション

![Lightningトランザクションとコミットメントトランザクション](https://youtu.be/aPqI34tpypM)

![表紙](assets/chapitre4/1.JPG)

さて、Lightning Network 上のチャネル内で資金を移動する際に実際に何が起こっているか、特にコミットメントトランザクションの概念について考えてみましょう。オンチェーンの引き出し/クローズトランザクションは、チャネルの状態を表しており、各転送後に資金が誰のものかを保証しています。

したがって、Lightning Network の転送後、2 つのペア、Alice と Bob の間で実行されないこのトランザクション/コンタクトの更新が行われます。Alice と Bob は、現在のチャネルの状態を持つ同じトランザクションを作成します。これはクローズ時に使用されます。

- Alice は Bob とのチャネルを 130,000 SAT で作成します。クローズ時に双方が受け入れる引き出しトランザクションによれば、130,000 SAT が Alice に送られます。Bob はこれに同意します。

![表紙](assets/chapitre4/2.JPG)

- Alice は Bob に 30,000 SAT を送ります。したがって、新しい引き出しトランザクションが作成され、クローズ時に Alice が 100,000 SAT を受け取り、Bob が 30,000 SAT を受け取ることが示されます。両者はこれに同意します。

![表紙](assets/chapitre4/3.JPG)

- Alice は Bob に 10,000 SAT を送ります。新しい引き出しトランザクションが再度作成され、クローズ時に Alice が 90,000 SAT を受け取り、Bob が 40,000 SAT を受け取ることが示されます。両者はこれに同意します。

![表紙](assets/chapitre4/4.JPG)

```
チャネルの初期状態：
Alice（130,000 SAT）============== Bob（0 SAT）

最初の転送後：
Alice（100,000 SAT）============== Bob（30,000 SAT）

2番目の転送後：
Alice（90,000 SAT）============== Bob（40,000 SAT）

```

お金は動かないが、最終的なバランスは署名されていないトランザクションを介して更新される。したがって、引き出しトランザクションはコミットメントトランザクションです。サトシの転送は、バランスを更新する別の最新のコミットメントトランザクションです。

## コミットメントトランザクション

![トランザクションのパート2](https://youtu.be/RRvoVTLRJ84)

コミットメントトランザクションは、チャネルのリキッド状態を X 時点で示すものですが、古い状態を公開してしまうことはできるのでしょうか？答えは「はい」です。なぜなら、公開されていないトランザクションにはすでに両参加者の事前署名が含まれているからです。

![指示](assets/Chapitre5/0.JPG)

この問題を解決するために、複雑さを追加します：

- Timelock = ブロック N まで資金がロックされる
- リボケーションキー = Alice の秘密と Bob の秘密

これらの要素はコミットメントトランザクションに追加されます。したがって、Alice は必ず Timelock の終了を待たなければならず、リボケーションキーを持つ人は Timelock の終了を待たずに資金を移動することができます。Alice が不正行為を試みると、Bob はリボケーションキーを使用して Alice から資金を奪い、罰することができます。

![指示](assets/Chapitre5/1.JPG)

今後（実際には）、Alice と Bob のコミットメントトランザクションは同じではありません。それらは対称的ですが、それぞれ異なる制約を持っています。彼らはお互いに秘密を与え、前のコミットメントトランザクションのリボケーションキーを作成します。したがって、Alice は Bob とチャネルを作成し、自分の側に 130,000 SAT を持ち、即座にお金を引き出すことはできません。少し待たなければなりません。リボケーションキーはお金を解除することができますが、Alice だけがそれを持っています（Alice のコミットメントトランザクション）。転送が行われると、Alice は Bob に以前の秘密を提供し、したがって、Alice が不正行為を試みる場合、Bob はチャネルを以前の状態に戻すことができます（Alice は罰せられます）。

![指示](assets/Chapitre5/2.JPG)

同様に、Bob は Alice に彼の秘密を提供します。Alice が不正行為を試みた場合に罰するためです。この操作は、新しいコミットメントトランザクションごとに繰り返されます。新しい秘密と新しいリボケーションキーが決定されます。したがって、新しいトランザクションごとに前のコミットメントトランザクションを破棄する必要があります。したがって、Alice または Bob が不正行為を試みる場合、もう一方は（Timelock のおかげで）それに先立って行動し、不正行為を防ぐことができます。トランザクション 3 の際には、トランザクション 2 の秘密を提供して、Alice と Bob が Alice または Bob に対して自己防衛できるようにします。

![指示](assets/Chapitre5/3.JPG)
タイムロックでトランザクションを作成する人（お金を送る人）は、タイムロック後にのみリボケーションキーを使用できます。しかし、お金を受け取る人は、ライトニングネットワーク上のチャネルの片側からもう片側に不正行為がある場合には、タイムロック前に使用することができます。特に、チャネル内の相手からの不正行為に対する保護機構について詳しく説明します。

## チャネルのクローズ

![チャネルを閉じる](https://youtu.be/FVmQvNpVW8Y)

私たちは、さまざまな形式を取るビットコインのトランザクションを介したチャネルのクローズに興味を持っています。チャネルのクローズには 3 つのタイプがあります：

- グッド：協力的なクローズ
- バッド：強制的なクローズ（非協力的）
- アウトロー：不正行為によるクローズ

![instruction](assets/chapitre6/1.JPG)
![instruction](assets/chapitre6/0.JPG)

### グッド

両者が話し合い、チャネルを閉じることに同意します。したがって、すべてのトランザクションを停止し、チャネルの最終状態を確定します。ネットワーク手数料について合意します（チャネルを開いた人がクローズの手数料を支払います）。これにより、クローズトランザクションが作成されます。したがって、タイムロックやリボケーションキーは存在せず、エンゲージメントトランザクションとは異なります。トランザクションが公開され、アリスとボブはそれぞれの残高を受け取ります。このタイプのクローズは一般的に迅速です（タイムロックがないため）し、一般的に費用がかかりません。

![instruction](assets/chapitre6/3.JPG)

### バッド

アリスはチャネルを閉じたいが、ボブはオフラインで応答しない（インターネットや電力の断絶など）。したがって、アリスは最新のエンゲージメントトランザクションを公開します。トランザクションが公開され、タイムロックがアクティブになります。したがって、このトランザクションの作成時に決定された手数料が X 時間前になります！ MemPool は変更されたネットワークであり、プロトコルはトランザクションの作成時の現在の手数料の 5 倍をデフォルトで使用します。手数料は 10 SAT で作成され、トランザクションは 50 SAT と見なされます。強制的に公開する時点で、クロージングトランザクションのネットワークは次のようになります：

- 1 SAT = 50 倍のオーバーペイメント
- 100 SAT = 2 倍のアンダーペイメント

これにより、強制的なクローズはより長く（タイムロックがあるため）なり、特に手数料の面でより危険であり、マイナーによる可能な検証が可能です。

![instruction](assets/chapitre6/4.JPG)

### アウトロー

アリスは、古いコミットメントトランザクションを公開して不正行為を試みています。しかし、ボブは MemPool を監視し、古いトランザクションを公開しようとするトランザクションがあるかどうかを見張っています。見つかった場合、ボブはリボケーションキーを使用してアリスを罰し、チャネルのすべての SAT を取ります。
![instruction](assets/chapitre6/5.JPG)

結論として、ライトニングネットワークにおけるチャネルのクローズは、さまざまな形で行われる重要なステップです。協力的なクローズでは、両当事者がコミュニケーションを取り、チャネルの最終状態に合意します。これは最も迅速で費用のかからないオプションです。一方、強制的なクローズは、一方の当事者が応答しない場合に発生します。これは予測できないトランザクション手数料とタイムロックのアクティベーションのため、より高コストでより長い時間がかかります。最後に、参加者が古いコミットメントトランザクションを公開して不正行為を試みる場合、詐欺師はチャネルのすべての SAT を失うことで罰せられる可能性があります。したがって、ライトニングネットワークを効果的かつ公正に使用するためには、これらのメカニズムを理解することが重要です。

# リキッドネットワーク

## ライトニングネットワーク

![lightning le réseau](https://youtu.be/RAZAa3v41DM)

この第 7 章では、ライトニングがチャネルネットワークとしてどのように機能し、支払いがソースから目的地にどのようにルーティングされるかについて説明します。

ライトニングは支払いチャネルのネットワークです。つまり、数千のノードが相互に接続され、非接続のノード間でトランザクションを実行するために自己利用される流動性チャネルが存在します。

![cover](assets/Chapitre7/0.JPG)
![cover](assets/Chapitre7/1.JPG)

チャネルの流動性は他のチャネルに移動することはできません。

`アリス -> エデン -> ボブ`。サトシは`アリス -> ボブ`ではなく、`アリス -> エデン`と`エデン -> ボブ`から移動しました。

したがって、各個人とチャネルには異なる流動性があります。支払いを行うためには、十分な流動性を持つネットワーク内のルートを見つける必要があります。不足している場合、支払いは成功しません。

次のネットワークを考えてみましょう：

```
ネットワークの初期状態：
アリス（130 SAT）====（0 SAT）スージー（90 SAT）====（200 SAT）エデン（150 SAT）====（100 SAT）ボブ
```

![cover](assets/Chapitre7/2.JPG)

アリスがボブに 40 SAT の転送を行う場合、流動性は両当事者の間のルートに沿って再分配されます。

```
アリスからボブへの40 SATの転送後：
アリス（90 SAT）====（40 SAT）スージー（50 SAT）====（240 SAT）エデン（110 SAT）====（140 SAT）ボブ
```

![cover](assets/Chapitre7/4.JPG)
ただし、初期状態では、Bob は 40 SAT を Alice に送ることができません。なぜなら、Susie は Alice に 40 SAT を送るための流動性を持っていないため、この経路を介した支払いは不可能だからです。したがって、トランザクションが不可能な別の経路が必要です。
最初の例では、Susie と Eden は何も失ったり得たりしていません。Lightning Network のノードがトランザクションのルーティングに使用されることを受け入れるためには、手数料が必要です！

流動性の場所によって異なる手数料があります

Alice - Bob

- Alice の手数料 = Alice -> Bob
- Bob の手数料 = Bob -> Alice

![cover](assets/Chapitre7/5.JPG)

手数料には 2 種類あります：

- 金額に関係なく固定の手数料：1 SAT（デフォルトで変更可能）
- 変動手数料（デフォルトで 0.01％）

手数料の例：

- Alice - Susie; 1/1（固定手数料 1、変動手数料 1）
- Susie - Eden; 0/200
- Eden - Bob; 1/1

したがって：

- 手数料 1：（Alice が自分自身に支払う）1 +（40,000 / \* 0.000001）
- 手数料 2：0 + 40,000 /\* 0.0002 = 8 SAT
- 手数料 3：1 + 40,000 /\* 0.000001 = 0.4 SAT

![cover](assets/Chapitre7/6.JPG)

送信：

1. 40,009.04 Alice -> Susie への送信；Alice は自分自身に手数料を支払うので、これはカウントされません
2. Susie は 40,001.04 を Eden に送信するサービスを提供し、8 SAT の手数料を取ります
3. Eden は 40,000 を Bob に送信するサービスを提供し、1.04 SAT の手数料を取ります。

Alice は 9.04 SAT の手数料を支払い、Bob は 40,000 SAT を受け取りました。

![cover](assets/Chapitre7/7.JPG)

LN では、送信前に Alice のノードがルートを決定します。したがって、最適なルートを検索し、Alice だけがルートと価格を知っています。支払いは送信されますが、Susie には情報がありません。

![cover](assets/Chapitre7/9.JPG)

Susie または Eden にとって、最終的な受取人や送信者はわかりません。これはオニオンルーティングです。ノードはネットワークのプランを保持して自分のルートを見つける必要がありますが、中間者のどれも情報を持っていません。

## HTLC - ハッシュタイムロック付き契約

![HTLC](https://youtu.be/-JC4mkq7H48)

通常のルーティングシステムでは、Eden が契約の一部を遵守せずに不正行為を行わないようにする方法はありますか？

HTLC は、秘密のみでロックを解除できる支払い契約です。秘密が明かされない場合、契約は期限切れになります。したがって、これは条件付きの支払いです。どのように使用されますか？
![instruction](assets/chapitre8/0.JPG)
次の状況を考えてみましょう。
`Alice (100,000 SAT) ==== (30,000 SAT) Susie (250,000 SAT) ==== (0 SAT) Bob`

- Bob は秘密の S（プレイイメージ）を生成し、ハッシュ r = hash(s)を計算します。
- Bob は「r」を含む請求書を Alice に送ります。
- Alice は「s'」を明らかにする条件で Susie に 40,000 SAT の HTLC を送ります（ただし、hash(s') = r）。
- Susie は Bob に同様の HTLC を送ります。
- Bob は「s」を示すことで Susie の HTLC をアンロックします。
- Susie は「S」を示すことで Alice の HTLC をアンロックします。

Bob がオフラインであり、お金を受け取る正当性を与える秘密を決して取得しない場合、HTLC は一定のブロック数後に期限切れになります。

![instruction](assets/chapitre8/1.JPG)

HTLC は最後から最初の順に期限切れになります：つまり、Susie - Bob の期限切れ、そして Alice - Susie の期限切れです。
これにより、Bob が戻ってきても何も変わりません。逆に、Alice が Bob が戻ってきたときにキャンセルすると、混乱が生じ、人々が無駄に働く可能性があります。

では、クロージャの場合、どうなるのでしょうか？実際には、私たちのコミットメントトランザクションはさらに複雑です。チャネルが閉じられる可能性がある場合、中間バランスを表す必要があります。

したがって、コミットメントトランザクションには、HTLC-out（前述の制限付き）が出力番号 3 を介して含まれています。

![instruction](assets/chapitre8/2.JPG)

Alice のコミットメントトランザクションには次のものが含まれています：

- 出力番号 1：Alice のための 60,000 SAT、Timelock とリボケーションキーを介して（残りの金額）
- 出力番号 2：すでに Susie に所属している 30,000 SAT
- 出力番号 3：40,000 SAT の HTLC

Alice のコミットメントトランザクションは HTCL-out を持っており、宛先である Susie に HTLC-in を送信しています。

![instruction](assets/chapitre8/3.JPG)

したがって、このコミットメントトランザクションを公開すると、Susie は「s」のイメージで HTCL のお金を回収することができます。プレイイメージを持っていない場合、HTCL が期限切れになった後に Alice がお金を回収します。出力（UTXO）を異なる条件付きの支払いと考えてください。
支払いが行われた後（期限切れまたは実行）、チャネルの状態が変わり、HTCL を含むトランザクションは存在しなくなります。通常のものに戻ります。
協力的なクロージャの場合：支払いを停止し、転送/HTCL の実行を待ちます。トランザクションは軽量であり、最大 1 つまたは 2 つの出力があるため、より安価です。

強制的なクロージャの場合：進行中のすべての HTLC を公開するため、非常に重く、非常に高価になります。そして、混乱が生じます。
要約すると、Lightning Network のルーティングシステムは、Hash Time-Locked Contracts（HTLC）を使用して安全かつ検証可能な支払いを保証します。HTLC は条件付きの支払いを実現し、お金が秘密でしかロック解除されないようにすることで、参加者が自分の約束を守ることを保証します。この例では、Alice は Susie を介して Bob に SAT を送りたいと考えています。Bob は秘密を生成し、そのハッシュを Alice に渡します。Alice と Susie は、このハッシュに基づいて HTLC を設定します。Bob が秘密を示して Susie の HTLC をロック解除すると、Susie は Alice の HTLC をロック解除することができます。

Bob が一定の時間内に秘密を明かさない場合、HTLC は期限切れになります。期限切れは最後から最初の順に発生し、Bob がオンラインに戻った場合に望ましくない結果が生じないようにします。

チャネルのクローズ時、協力的なクローズの場合、支払いは中断され、HTLC は解決されますが、通常はコストが低くなります。強制的なクローズの場合、進行中のすべての HTLC トランザクションが公開され、非常に高額で混乱を招く可能性があります。要するに、HTLC のメカニズムは Lightning Network に追加のセキュリティレイヤーを提供し、支払いが正しく実行され、ユーザーが自分の約束を守ることを保証します。

## 自分の道を見つける

![自分の道を見つける](https://youtu.be/wnUGJjOxd9Q)

唯一の公開データはチャネルの総容量（Alice + Bob）ですが、流動性がどこにあるかはわかりません。
より詳細な情報を得るために、私たちのノードは LN の通信チャネルを監視し、新しいチャネルのアナウンスやチャネル料金の更新を受け取ります。また、チャネルのクローズを確認するためにブロックチェーンも監視します。

私たちが持っている情報がすべてではないため、私たちは持っている情報（チャネルの最大容量）でグラフ/ルートの検索を行う必要があります。

基準：

- 成功確率
- 手数料
- HTLC の有効期限
- 中間ノードの数
- ランダム性

したがって、3 つの可能なルートがある場合：

- Alice > 1 > 2 > 5 > Bob
- Alice > 1 > 2 > 4 > 5 > Bob
- Alice 1 > 2 > 3 > Bob

理論的には、手数料が最も少なく、成功確率が最も高い最適なルートを探します：最大の流動性と最小のホップ数。

たとえば、2-3 の容量が 130,000 SAT しかない場合、100,000 を送信することは非常に確率が低いため、選択肢 3 は成功の可能性がほとんどありません。

![グラフ](assets/chapitre9/2.JPG)
アルゴリズムは 3 つの選択肢を選び、最初の選択肢を試すことになりました：
選択肢 1：

- アリスは 100,000 SAT の HTCL を 1 に送信します。
- 1 は 2 に対して 100,000 SAT の HTLC を行います。
- 2 は 5 に対して 100,000 SAT の HTLC を行いますが、5 はできないため、アナウンスします。

情報が返されたため、アリスは 2 番目の経路を試すことに決めました：

- アリスは 1 に対して 100,000 の HTLC を送信します。
- 1 は 2 に対して 100,000 の HTLC を行います。
- 2 は 4 に対して 100,000 の HTLC を行います。
- 4 は Bob に対して 100,000 の HTLC を行います。Bob は流動性を持っているため、問題ありません。
- Bob は HTLC のプレイメージ（ハッシュ）を使用し、秘密を使用して 100,000 SAT を回収します。
- 5 は 4 のブロックされた HTLC を回収するために HTLC の秘密を持っています。
- 4 は 2 のブロックされた HTLC を回収するために HTLC の秘密を持っています。
- 2 は 1 のブロックされた HTLC を回収するために HTLC の秘密を持っています。
- 1 はアリスのブロックされた HTLC を回収するために HTLC の秘密を持っています。

アリスはルート 1 の失敗を見ていませんが、ただ 1 秒待っているだけです。支払いの失敗は、ルートが存在しない場合に発生します。ルートの検索を容易にするため、Bob はアリスに支援するための情報を提供することができます：

- 金額
- 自身のアドレス
- アリスが HTLC を作成できるようにするためのプレイメージのハッシュ
- Bob のチャネルに関する情報

Bob は、直接接続されているため、チャネル 5 と 3 の流動性を知っていますので、アリスにそれを伝えることができます。ノード 3 は不要であることをアリスに通知することで、アリスが不要な経路を取るのを防ぎます。
もう 1 つの要素は、Bob が持っている非公開のチャネルです。Bob が 1 との非公開のチャネルを持っている場合、アリスにそれを使用するように指示することができます。これにより、アリス > 1 > Bob となります。

![graph](assets/chapitre9/3.JPG)

結論として、Lightning Network 上のトランザクションのルーティングは、さまざまな要素を考慮に入れる複雑なプロセスです。チャネルの総容量は公開されていますが、流動性の正確な分布は直接アクセスできません。これにより、ノードは手数料、HTLC の有効期限、中間ノードの数、およびランダム要素などの基準を考慮して、最も成功の可能性が高いルートを推定する必要があります。
複数の経路が可能な場合、ノードは手数料を最小化し、成功の可能性を最大化するために、十分な流動性と最小限のホップ数を持つチャネルを選択することを目指します。流動性が不足しているためにトランザクションが失敗した場合、別の経路が試され、成功するまで繰り返されます。
また、経路の検索を容易にするために、受信者はアドレス、金額、プレイイメージのハッシュ、およびチャネルに関する情報などの追加情報を提供することができます。これにより、十分な流動性を持つチャネルを特定し、不要なトランザクションの試行を回避するのに役立ちます。
最終的に、Lightning Network のルーティングシステムは、トランザクションの速度、セキュリティ、効率を最適化すると同時に、ユーザーのプライバシーを保護するために設計されています。

# Lightning Network のツール

## Invoice、LNURL、Keysend

![invoice, LNURL, Keysend](https://youtu.be/CHnXJuZTarU)

![cover](assets/chapitre10/0.JPG)

LN 請求書（またはインボイス）は長くて読みにくいですが、要求された支払いを密集して表現することができます。

例：
lnbc1m1pskuawzpp5qeuuva2txazy5g483tuv9pznn9ft8l5e49s5dndj2pqq0ptyn8msdqqcqzpgxqrrsssp5v4s00u579atm0em6eqm9nr7d0vr64z5j2sm5s33x3r9m4lgfdueq9qyyssqxkjzzgx5ef7ez3dks0laxayx4grrw7j22ppgzyhpydtv6hmc39skf9hjxn5yd3kvv7zpjdxd2s7crcnemh2fz26mnr6zu83w0a2fwxcqnvujl3

- lnbc1m = 読みやすい部分
- 1 = 残りとの区切り
- 残りの部分
- Bc1 = Bech32 エンコーディング（ベース 32）、したがって 32 文字を使用します。
- 10 = 1.2.3.4.5.6.7.8.9.0
- 26 = abcdefghijklmnopqrstuvwxyz
- 32 = 「b-i-o」ではなく、「1」ではない

### lnbc1m

- ln = Lightning
- Bc = bitcoin（メインネット）
- 1 = 金額
- M = ミリ（10^-3 / u = マイクロ 10^-6 / n = ナノ 10^-9 / p = ピコ 10^-12

ここでは、1m = 1 /\* 0.0001btc = 100,000 BTC
「pskuawzpp5qeuuva2txazy5g483tuv9pznn9ft8l5e49s5dndj2pqq0ptyn8msdqqcqzpgxqrrsssp5v4s00u579atm0em6eqm9nr7d0vr64z5j2sm5s33x3r9m4lgfdueq9qyyssqxkjzzgx5ef7ez3dks0laxayx4grrw7j22ppgzyhpydtv6hmc39skf9hjxn5yd3kvv7zpjdxd2s7crcnemh2fz26mnr6zu83w0a2fwxcqnvujl3」というメインネットビットコインのライトニングネットワーク上での支払い 100,000 SAT を支払うように求められました。

### タイムスタンプ（作成された時刻）

以下の 0 個または複数の追加パートを含むことがあります：

- プレイイメージのハッシュ
- 支払いの秘密（オニオンルーティング）
- 任意のデータ
- 宛先の LN 公開鍵
- 有効期限（デフォルトは 1 時間）
- ルーティングの指示
- 全体の署名

他の種類の請求書も存在します。LNURL メタプロトコルは、リクエストをする代わりに直接サトシの金額を提供することができます。これは非常に柔軟で、ユーザーエクスペリエンスの向上に多くの改善をもたらします。

![cover](assets/chapitre10/2.JPG)

キーセンドを使用すると、Alice は Bob にリクエストをすることなくお金を送ることができます。Alice は Bob の ID を取得し、Bob に尋ねることなくプレイイメージを作成し、それを送信に含めます。したがって、Bob は Alice がすでに作業を完了しているため、お金を解除できる驚きのリクエストを受け取ります。

![cover](assets/chapitre10/3.JPG)

結論として、ライトニングネットワークの請求書は、初めて見たときには複雑に見えるかもしれませんが、効率的に支払いのリクエストをエンコードしています。請求書の各セクションには、支払う金額、宛先、作成時のタイムスタンプ、およびプレイイメージのハッシュ、支払いの秘密、ルーティングの指示、有効期限などの他の情報が含まれています。LNURL やキーセンドなどのプロトコルは、相手の事前のリクエストなしに資金を送るなど、柔軟性とユーザーエクスペリエンスの面で重要な改善を提供します。これらの技術により、ライトニングネットワーク上の支払いプロセスがスムーズで効率的になります。

## リキッドティの管理

![gerer sa liquidité](https://youtu.be/YuPrbhEJXbg)

ライトニングネットワーク上のリキッドティの管理に関する永遠の質問に対する一般的なガイドラインを提供します。

![instruction](assets/chapitre11/0.JPG)

LN には 3 つのタイプの人物がいます：

- 購入者：彼らは送金可能なリキッドティを持っています。これは最も簡単です。チャネルを開くだけで十分です。
- 商人：商人は他のノードやアクターを介しての流動性が必要であり、彼らには彼らに接続された人々が必要です。
- ルーティングノード：彼らは両側の流動性と多くのノードへの良好な接続を持つことを望んでおり、できるだけ多く使用されるようにしたいです。

したがって、流動性が必要な場合は、サービスで購入することができます。

![instruction](assets/chapitre11/1.JPG)

アリスはスージーとのチャネルを 100 万サトシで購入し、そのために直接 100 万 SAT の入金側のチャネルを開きます。したがって、スージー（非常に接続されている）に接続された顧客から最大 100 万 SAT の支払いを受け入れることができます。

別の解決策は支払いを行うことです。100,000 を支払うと、100,000 を受け取ることができます。

![instruction](assets/chapitre11/2.JPG)

### ループアウトソリューション：Atomic swap LN - BTC

アリス 2 百万 - スージー 0

![instruction](assets/chapitre11/3.JPG)

アリスは流動性をスージーに送りたいので、ループアウト（LN/BTC のバランス調整のための特別なノード）を行います。
アリスはスージーのノードを介してループに 100 万を送信し、スージーは流動性を持ち、ループはアリスのノードにオンチェーンのバランスを返します。

![instruction](assets/chapitre11/4.JPG)

したがって、100 万がスージーに送られ、スージーは 100 万をループに送り、ループは 100 万をアリスに送ります。アリスはいくらかの手数料をループに支払って流動性をスージーに移動しました。

LN で最も複雑なのは流動性を維持することです。

![instruction](assets/chapitre11/5.JPG)

まとめると、Lightning Network 上での流動性の管理は、購入者、商人、およびルーティングノードのタイプに依存する重要な課題です。流動性の出口が必要な購入者は、単にチャネルを開くだけで簡単なタスクを持っています。流動性の入口が必要な商人は、他のノードやアクターに接続する必要があります。ルーティングノードは、両側の流動性のバランスを維持しようとします。チャネルの購入や受信容量の増加のための支払いなど、流動性を管理するためのさまざまな解決策が存在します。LN と BTC の間での Atomic Swap を可能にする「ループアウト」オプションは、流動性を調整するための興味深い解決策を提供します。これらの戦略にもかかわらず、Lightning Network 上での流動性の維持は複雑な課題です。

# もっと進む

## トレーニングの要約

![conclusion](https://youtu.be/MaWpD0rbkVo)

私たちの目標は、Lightning Network がどのように機能し、Bitcoin に依存しているかを説明することでした。
ライトニングネットワークは、支払いチャネルのネットワークです。支払いチャネルの動作方法については既に説明しましたが、ネットワーク全体や支払いチャネルのネットワークの概念にも目を向けました。
![instruction](assets/chapitre12/0.JPG)

チャネルはビットコインのトランザクションを通じて開かれ、可能な限り多くのトランザクションを受け入れることができます。チャネルの状態は、各関係者がチャネルの一方の側に持っているものを送信するコミットメントトランザクションによって表されます。チャネル内でトランザクションが行われると、関係者は古い状態を無効にし、新しいコミットメントトランザクションを構築することで新しい状態に合意します。

![instruction](assets/chapitre12/1.JPG)

ペアは、リボケーションキーとタイムロックを使用して不正行為から保護されます。チャネルを閉じるためには、相互に合意された閉鎖が望ましいです。強制的な閉鎖の場合、最後のコミットメントトランザクションが公開されます。

![instruction](assets/chapitre12/3.JPG)

支払いは他の中間ノードのチャネルを経由して行われることがあります。支払いの完全な解決を待つために、条件付き支払い（HTLC）が資金をブロックすることができます。ライトニングネットワークではオニオンルーティングが使用されます。中間ノードは支払いの最終目的地を知りません。アリスは支払いのルートを計算する必要がありますが、中間チャネルの流動性に関するすべての情報を持っていません。

![instruction](assets/chapitre12/4.JPG)

ライトニングネットワークを介して支払いを送信する際には、確率の要素があります。

![instruction](assets/chapitre12/5.JPG)

支払いを受け取るには、チャネル内の流動性を管理する必要があります。これは、他の人にチャネルを開いてもらったり、自分でチャネルを開いたり、ループなどのツールを使用したり、マーケットプレイスでチャネルを購入/レンタルしたりすることで実現できます。

## ファニスへのインタビュー

![ファニスへのインタビュー](https://youtu.be/VeJ4oJIXo9k)

以下はインタビューの要約です：

ライトニングネットワークは、ビットコイン上で超高速な支払いソリューションであり、ネットワークのスケーラビリティに関連する制約を回避することができます。ただし、ライトニング上のビットコインは、スケーラビリティを犠牲にして分散化とセキュリティを優先しているため、チェーン上のビットコインほど安全ではありません。

ブロックサイズの過度の増加は良い解決策ではありません。これにはノードとデータ容量の妥協が伴います。その代わり、ライトニングネットワークでは、ビットコインのユーザー間でトランザクションをブロックチェーンに表示せずに支払いチャネルを作成することができます。これにより、ブロック上のスペースを節約し、ビットコインを今日のスケーラビリティに対応させることができます。
しかし、Lightning Network のスケーラビリティと中央集権化に関する批判があり、チャネルのクローズや高いトランザクション手数料に関連する潜在的な問題があります。これらの問題を解決するためには、将来の問題を避けるために小さなチャネルを開かないことや、Child Pay for Parent でトランザクション手数料を増やすことが推奨されています。

Lightning Network の将来に向けて検討されている解決策には、バッチ処理やグループでのチャネル作成によるトランザクション手数料の削減、そして長期的にはブロックサイズの増加があります。ただし、Lightning 上のビットコインはビットコインチェーン上のビットコインほど安全ではないことに注意することが重要です。

ビットコインと Lightning のプライバシーは関連しており、オニオンルーティングによってトランザクションの一定レベルのプライバシーが保証されています。しかし、ビットコインではデフォルトですべてが透明であり、ビットコインチェーン上でアドレスからアドレスへのビットコインの追跡にヒューリスティックスが使用されています。

KYC でビットコインを購入することで、取引所は引き出しトランザクションを知ることができます。また、丸められた金額や交換アドレスは、トランザクションの一部が他の人に destine され、一部が自分自身に destine されていることを知る手がかりとなります。

プライバシーを向上させるために、ジョイントアクションやコインジョインは、複数の人々が一緒にトランザクションを行うことで確率計算を妨害します。チェーン分析会社は、あなたがビットコインをどのように使っているかを追跡するのがより困難になります。

Lightning では、トランザクションに関与するのは 2 人だけであり、ビットコインよりもプライバシーが高いです。オニオンルーティングにより、中間ノードは支払いの送信者と受信者を知ることはありません。

Lightning Network を使用するには、YouTube チャンネルでのトレーニングや Bitcoin を発見するサイトでのトレーニングを受けることをおすすめします。また、Lightning 上での支払い時には、それに専用のフィールドを使用して任意のテキストを送信することも可能であり、寄付やメッセージングに役立ちます。

ただし、Lightning 上のルーティングノードは将来的に規制される可能性があり、一部の国がルーティングノードを規制しようとするかもしれません。

商人にとっては、Lightning Network で支払いを受けるためには流動性を管理する必要があります。現在の制約は適切な解決策で克服することができます。

最後に、ビットコインの将来は有望であり、5 年で 100 万に達する可能性があります。業界の専門化と既存の銀行システムに代わるシステムの構築を確保するためには、ネットワークへの貢献と信頼の停止が重要です。

## 感謝とウサギの穴を掘り続ける

Bitcoin の穴に降りる人は少ないので、自分に誇りを持ってください。

まず、Fanis Makalakis さんには、ライトニングのより民族的な側面についてのこの素晴らしい無料コースを提供していただき、本当にありがとうございます。彼の Twitter、ブログ、または LN market で彼の仕事をフォローしてください。

また、プロジェクトをサポートしたい場合は、Patreon でスポンサーになってください。寄付は新しいトレーニングコンテンツの制作に役立ち、もちろん、次の Fanis のコースについても最初にお知らせします。

ライトニングネットワークの冒険は、Umbrel のトレーニングとライトニングネットワークノードの設置で続きます。理論は終わりで、今度は実践の時間です！ LN 202 のトレーニングです！

キスして、またすぐに会いましょう！

Rogzy
